<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Absensi Angkringan Modern</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        /* ========================================================== */
        /* 1. VARIABEL & RESET DASAR                                  */
        /* ========================================================== */
        :root{
            /* Palet Warna Nuansa Kopi/Angkringan */
            --bg: #f7f5f3;
            --card: #ffffff;
            --text: #1c1c1e;
            --muted: rgba(28,28,30,0.6);
            --accent-primary: #8B4513; /* cokelat */
            --accent-secondary: #D2B48C; /* krem */
            --accent-red: #ff4d4d;
            --accent-green: #4CAF50;
            --accent-orange: #FFC107;
            --soft-shadow: 0 6px 18px rgba(16,24,40,0.06);
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        *{box-sizing:border-box}
        body {
            font-family: var(--font-family);
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app {
            width: 100%;
            max-width: 480px;
            padding: 20px;
            padding-bottom: 70px; /* Ruang untuk toast */
        }
        
        /* ========================================================== */
        /* 2. KOMPONEN UTAMA (BANNER, GRID, CARD)                     */
        /* ========================================================== */
        .banner {
            background: linear-gradient(135deg, var(--accent-primary), #6d350f);
            color: white;
            border-radius: 14px;
            padding: 22px 18px;
            text-align: center;
            margin-bottom: 18px;
            box-shadow: var(--soft-shadow);
        }
        
        .banner #status-ringkas {
            font-size: 14px; 
            margin-top: 10px; 
            font-weight: 700; 
            background: rgba(255,255,255,0.08); 
            display:inline-block;
            padding: 8px 10px; 
            border-radius: 8px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 14px;
        }

        .grid-three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .card-action {
            background: var(--card);
            border-radius: 14px;
            padding: 12px 10px;
            cursor: pointer;
            text-align: center;
            box-shadow: var(--soft-shadow);
            font-weight: 700;
            transition: transform 0.18s, background-color 0.18s;
            font-size: 14px; 
            user-select: none;
        }

        .card-action:active {
            transform: scale(0.98);
            background-color: var(--bg); 
        }

        .section-title { 
            font-weight: 800; 
            margin: 8px 4px 12px; 
            font-size: 18px; 
            color: var(--accent-primary);
        }
        
        /* Tombol Absen Besar */
        .card-action.absen-btn {
            font-size: 20px;
            padding: 18px 12px;
            background: linear-gradient(180deg, var(--accent-green), #3b8e3b);
            color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(76,175,80,0.12);
            transform-origin: center;
        }

        .card-action.absen-btn:hover {
            transform: translateY(-4px) scale(1.02);
        }

        /* Animasi tekan */
        .card-action.absen-btn:active {
            animation: pressPulse 260ms ease;
        }

        @keyframes pressPulse {
            0% { transform: scale(1); box-shadow: 0 10px 30px rgba(76,175,80,0.12); }
            50% { transform: scale(0.96); box-shadow: 0 6px 18px rgba(76,175,80,0.08); }
            100% { transform: scale(1); box-shadow: 0 10px 30px rgba(76,175,80,0.12); }
        }

        /* ========================================================== */
        /* 3. RIWAYAT ABSENSI                                         */
        /* ========================================================== */
        .riwayat-item {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--soft-shadow);
            border-left: 5px solid transparent;
        }

        .riwayat-item.absen { border-left-color: var(--accent-green); }
        .riwayat-item.gantikan { border-left-color: var(--accent-orange); }

        .riwayat-item span {
            font-size: 13px;
            color: var(--muted);
            margin-top: 3px;
        }

        /* ========================================================== */
        /* 4. OVERLAY & FORM                                          */
        /* ========================================================== */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.35);
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
        }

        #overlay .panel {
            max-width: 520px;
            margin: 40px auto;
            background: var(--card);
            border-radius: 12px;
            padding: 18px;
            box-shadow: var(--soft-shadow);
        }
        
        .list-item {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            font-weight: 600;
            border-left: 5px solid var(--accent-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item.status-hadir { background-color: #e6ffe6; border-left-color: var(--accent-green); }
        .list-item.status-belum-hadir { background-color: #fff0f0; border-left-color: var(--accent-red); }
        .list-item.status-seharusnya-hadir { background-color: #fff8e1; border-left-color: var(--accent-orange); }

        .batal-btn-overlay {
            background: var(--accent-red);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 700;
        }

        #absensi-form label, #laporan-controls label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--text);
            font-size: 14px;
        }

        #absensi-form input[type="date"], #absensi-form input[type="time"], #absensi-form select,
        #laporan-controls select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 15px;
            background: #fafafa;
        }

        #absensi-form button, #laporan-controls button {
            background: var(--accent-primary);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.18s;
            margin-top: 6px;
        }

        #absensi-form button:hover, #laporan-controls button:hover {
            background: #6e3510;
        }

        /* Helpers */
        .row { display:flex; gap:10px; }
        .col { flex:1; }

        /* ========================================================== */
        /* 5. TOAST NOTIFICATION                                      */
        /* ========================================================== */
        #toast {
            visibility: hidden;
            min-width: 260px;
            margin-left: -130px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 14px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            font-size: 15px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.2);
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.4s, fadeout 0.4s 2.4s;
            animation: fadein 0.4s, fadeout 0.4s 2.4s;
        }

        @-webkit-keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @-webkit-keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
    </style>
</head>
<body>
    <div class="app">
        <div class="banner">
            <h1 style="margin:0; letter-spacing:0.6px;">ABSENSI ANGGKRINGAN</h1>
            <p style="margin:6px 0 0 0; opacity:0.95; font-weight:600;">Jam Kerja Fleksibel — Bisa Absen Kapan Saja</p>
            <div id="status-ringkas">
                Memuat status hari ini...
            </div>
        </div>
        
        <div class="grid grid-three" style="margin-bottom:14px;">
            <div class="card-action absen-btn" onclick="mulaiAbsen()">👋 Absen Sekarang</div>
            <div class="card-action" onclick="mulaiAbsenTanggalLain()">🗓️ Absen / Gantikan</div>
            <div class="card-action" onclick="mulaiGantikanQuick()">🔁 Gantikan Cepat</div>
        </div>
        
        <div class="grid" style="margin-bottom:12px;">
            <div class="card-action" onclick="tampilkanRanking()">🏆 Statistik Total</div>
            <div class="card-action" onclick="tampilkanLaporanBulanan()">🧾 Laporan Bulanan & Ekspor</div>
            <div class="card-action" onclick="tampilkanStatus()">📋 Status Jadwal</div>
            <div class="card-action" onclick="resetData()">⚠️ Reset Data</div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div class="section-title" onclick="mulaiFilterRiwayat()">Riwayat Absensi (<span id="filter-status">Semua Karyawan</span>)</div>
            <select id="sort-riwayat" onchange="tampilkan()" style="padding:8px; border-radius:8px; border:1px solid #e6e6e6;">
                <option value="terbaru">Terbaru</option>
                <option value="terlama">Terlama</option>
                <option value="nama_asc">Nama (A-Z)</option>
            </select>
        </div>

        <div id="riwayat"></div>
    </div>

    <div id="overlay"></div>
    <div id="toast"></div> 

    <script>
        // ----------------------------
        // KONFIGURASI & DATA AWAL
        // ----------------------------
        // Tidak ada lagi logika telat — semua dianggap tepat waktu
        function isTerlambat(/*waktuAbsen*/) { return false; }

        let data = JSON.parse(localStorage.getItem("absensi") || "[]");
        let karyawan = ["Lala", "Zaki", "Kemi", "Haris", "Izzul", "Fawaz"];
        let mode = null;
        let pengganti = null;
        let filterAktif = "Semua Karyawan";

        // Load / Simpan Jadwal Mingguan (persist di localStorage)
        const defaultJadwal = {
            "Senin": ["Lala", "Zaki", "Kemi"],
            "Selasa": ["Lala", "Haris", "Izzul"],
            "Rabu": ["Haris", "Kemi", "Zaki"],
            "Kamis": ["Fawaz", "Zaki", "Izzul"],
            "Jumat": ["Lala", "Haris", "Fawaz"],
            "Sabtu": ["Lala", "Zaki", "Fawaz", "Kemi", "Izzul", "Haris"],
            "Minggu": ["Fawaz", "Izzul"]
        };

        function loadJadwal() {
            const raw = localStorage.getItem('jadwalMingguan');
            if(!raw) {
                localStorage.setItem('jadwalMingguan', JSON.stringify(defaultJadwal));
                return JSON.parse(JSON.stringify(defaultJadwal));
            }
            try {
                const parsed = JSON.parse(raw);
                // Ensure keys exist
                ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"].forEach(d=>{
                    if(!Array.isArray(parsed[d])) parsed[d] = [];
                });
                return parsed;
            } catch(e) {
                localStorage.setItem('jadwalMingguan', JSON.stringify(defaultJadwal));
                return JSON.parse(JSON.stringify(defaultJadwal));
            }
        }

        function saveJadwal(jadwal){
            localStorage.setItem('jadwalMingguan', JSON.stringify(jadwal));
        }

        let JadwalMingguan = loadJadwal();

        // ----------------------------
        // UTILITIES
        // ----------------------------
        function todayDate(){ return new Date().toISOString().split('T')[0]; }

        function getTodayDayName(){
            const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            return days[new Date().getDay()];
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerHTML = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 2600);
        }

        function tutupOverlay(){
            document.getElementById("overlay").style.display="none";
            document.getElementById("overlay").innerHTML = "";
            mode = null; 
            pengganti = null; 
        }

        // ----------------------------
        // TAMPILKAN RIWAYAT
        // ----------------------------
        function tampilkan(){
            let wrap = document.getElementById("riwayat");
            wrap.innerHTML = "";
            document.getElementById('filter-status').innerText = filterAktif;

            let dataYangDitampilkan = data;
            if (filterAktif !== "Semua Karyawan") {
                dataYangDitampilkan = data.filter(d => 
                    (d.jenis === "Absen" && d.nama === filterAktif) || 
                    (d.jenis === "Gantikan" && (d.pengganti === filterAktif || d.digantikan === filterAktif))
                );
            }
            
            const jenisSort = document.getElementById('sort-riwayat') ? document.getElementById('sort-riwayat').value : 'terbaru';
            const dataTampil = [...dataYangDitampilkan].sort((a, b) => {
                const timeA = new Date(`${a.tanggal} ${a.waktu}`).getTime();
                const timeB = new Date(`${b.tanggal} ${b.waktu}`).getTime();

                if (jenisSort === "terbaru") return timeB - timeA;
                if (jenisSort === "terlama") return timeA - timeB;
                if (jenisSort === "nama_asc") {
                    const namaA = a.nama || a.pengganti;
                    const namaB = b.nama || b.pengganti;
                    if (namaA < namaB) return -1;
                    if (namaA > namaB) return 1;
                    return 0;
                }
                return timeB - timeA;
            });

            dataTampil.forEach((d, idx) => {
                let div = document.createElement("div");
                let kelasTambahan = '';
                if (d.jenis === 'Absen') kelasTambahan = ' absen';
                if (d.jenis === 'Gantikan') kelasTambahan = ' gantikan';

                div.className = `riwayat-item${kelasTambahan}`; 
                
                let content = "";
                if(d.jenis === "Absen"){
                    content = `
                        <div><strong>${d.nama} — Absen</strong>
                        <span>Pukul ${d.waktu} | Tanggal ${d.tanggal}</span></div>
                    `;
                } else {
                    content = `
                        <div><strong>${d.pengganti} menggantikan ${d.digantikan}</strong>
                        <span>Pukul ${d.waktu} | Tanggal ${d.tanggal}</span></div>
                    `;
                }
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        ${content}
                        <div 
                            onclick="hapusRiwayat(${idx})" 
                            style="color:var(--accent-red); cursor:pointer; font-weight:bold; padding: 6px 0 6px 10px; font-size:14px;"
                        >
                            ❌
                        </div>
                    </div>
                `;

                wrap.appendChild(div);
            });
            
            if (dataTampil.length === 0) {
                wrap.innerHTML = `<p style="text-align:center; color:var(--muted);">Tidak ada riwayat untuk ${filterAktif}.</p>`;
            }
            updateStatusRingkas();
        }

        function mulaiFilterRiwayat(){
            mode = "filter";
            const opsiFilter = ["Semua Karyawan", ...karyawan];
            tampilOverlayPilih(opsiFilter, "🔎 Filter Riwayat Berdasarkan:");
        }

        function filterRiwayat(nama){
            filterAktif = nama;
            tampilkan();
            tutupOverlay();
        }

        function hapusRiwayat(index) {
            if (index < 0 || index >= data.length) {
                showToast("Data tidak ditemukan.");
                return;
            }
            if (confirm(`Yakin ingin menghapus riwayat absensi ini?`)) {
                data.splice(index, 1);
                localStorage.setItem("absensi", JSON.stringify(data));
                showToast("Riwayat berhasil dihapus.");
                tampilkan();
            }
        }

        // ----------------------------
        // ABSEN & GANTIKAN (TERPADU)
        // ----------------------------
        function absen(nama, tanggal, waktu) {
            if(data.some(a => a.nama === nama && a.tanggal === tanggal && a.jenis === "Absen")){
                showToast(nama + ` sudah Absen pada tanggal ${tanggal}.`);
                return;
            }

            data.push({
                nama, 
                waktu,
                tanggal, 
                jenis: "Absen",
                status: "Tepat Waktu"
            });

            showToast(`✅ ${nama} berhasil Absen`);
            localStorage.setItem("absensi", JSON.stringify(data));
            tampilkan();
        }

        function gantikan(pengganti,digantikan,tanggal,waktu){
            data.push({pengganti,digantikan, waktu:waktu, tanggal:tanggal, jenis:"Gantikan"});
            localStorage.setItem("absensi",JSON.stringify(data));
            showToast(`${pengganti} berhasil menggantikan ${digantikan}.`);
            tampilkan();
        }

        function mulaiAbsen(){
            // Absen cepat: pilih nama langsung (waktu & tanggal otomatis sekarang)
            mode="absen";
            const hariIni = todayDate();
            const hadirHariIni = data
                .filter(d => d.tanggal === hariIni && d.jenis === "Absen")
                .map(d => d.nama);
            tampilOverlayPilih(karyawan,"👋 Pilih Karyawan yang Absen", hadirHariIni);
        }

        // FORM TERPADU: Absen Lain / Gantikan
        function mulaiAbsenTanggalLain() {
            mode = "absenLain";
            const ov = document.getElementById("overlay");
            const hariIni = todayDate();
            const waktuSekarang = new Date().toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' });

            ov.innerHTML = `
                <div class="panel">
                    <h3 style="margin-top:0;">🗓️ Absen / Gantikan (Form Terpadu)</h3>
                    <form id="absensi-form" onsubmit="event.preventDefault(); prosesAbsenLain()">
                        <label>Jenis:</label>
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <label style="flex:1"><input type="radio" name="jenis-absen" value="absen" checked> Absen Biasa</label>
                            <label style="flex:1"><input type="radio" name="jenis-absen" value="gantikan"> Gantikan</label>
                        </div>

                        <div id="form-absen-biasa">
                            <label for="karyawan-select">Pilih Karyawan (Absen):</label>
                            <select id="karyawan-select" required>
                                <option value="">-- Pilih Nama --</option>
                                ${karyawan.map(n => `<option value="${n}">${n}</option>`).join('')}
                            </select>
                        </div>

                        <div id="form-gantikan" style="display:none;">
                            <label for="pengganti-select">Pengganti (yang datang):</label>
                            <select id="pengganti-select">
                                <option value="">-- Pilih Pengganti --</option>
                                ${karyawan.map(n => `<option value="${n}">${n}</option>`).join('')}
                            </select>

                            <label for="digantikan-select">Digantikan (yang tidak masuk):</label>
                            <select id="digantikan-select">
                                <option value="">-- Pilih yang Digantikan --</option>
                                ${karyawan.map(n => `<option value="${n}">${n}</option>`).join('')}
                            </select>
                        </div>

                        <label for="tgl-absen">Tanggal:</label>
                        <input type="date" id="tgl-absen" max="${hariIni}" value="${hariIni}" required>

                        <label for="wkt-absen">Waktu (HH:MM):</label>
                        <input type="time" id="wkt-absen" value="${waktuSekarang}" required>

                        <button type="submit">Proses</button>
                    </form>

                    <div class="batal-btn-overlay" onclick="tutupOverlay()" style="margin-top:10px;">Batal</div>
                </div>
            `;

            // toggle form bagian berdasarkan jenis
            setTimeout(()=>{ // allow DOM insert
                const radios = document.querySelectorAll('input[name="jenis-absen"]');
                radios.forEach(r=>{
                    r.addEventListener('change', ()=>{
                        const val = document.querySelector('input[name="jenis-absen"]:checked').value;
                        document.getElementById('form-absen-biasa').style.display = val === 'absen' ? 'block' : 'none';
                        document.getElementById('form-gantikan').style.display = val === 'gantikan' ? 'block' : 'none';
                    });
                });
            },50);

            ov.style.display="block";
        }

        function prosesAbsenLain(){
            const jenis = document.querySelector('input[name="jenis-absen"]:checked').value;
            const tanggal = document.getElementById('tgl-absen').value;
            const waktu = document.getElementById('wkt-absen').value;

            if(jenis === 'absen'){
                const nama = document.getElementById('karyawan-select').value;
                if(!nama){ showToast("Pilih karyawan untuk absen."); return; }
                absen(nama,tanggal,waktu);
                tutupOverlay();
            } else {
                const pengg = document.getElementById('pengganti-select').value;
                const dig = document.getElementById('digantikan-select').value;
                if(!pengg || !dig){ showToast("Pilih pengganti dan yang digantikan."); return; }
                if(pengg === dig){ showToast("Pengganti tidak boleh sama dengan yang digantikan."); return; }
                gantikan(pengg, dig, tanggal, waktu);
                tutupOverlay();
            }
        }

        // Quick gantikan (memakai overlay pilih 2 nama berurutan)
        function mulaiGantikanQuick(){
            mode="gantikanQuick";
            tampilOverlayPilih(karyawan,"🔁 Pilih Pengganti (yang datang)");
        }

        // Overlay pilihan nama generik
        function tampilOverlayPilih(list,judul="Pilih Karyawan", hadirList = []){
            let ov=document.getElementById("overlay");
            ov.innerHTML = `<div class="panel"><h3 style="margin-top:0;">${judul}</h3></div>`;
            const panel = ov.querySelector('.panel');

            list.forEach(n=>{
                const sudahHadir = hadirList.includes(n);
                let item=document.createElement("div");
                item.className=`list-item ${sudahHadir ? 'status-hadir' : ''}`;
                item.innerHTML = `<span>${n}</span><span style="font-weight:700;">${sudahHadir ? 'Sudah Hadir' : 'Pilih'}</span>`;
                item.onclick=()=>pilihNama(n);
                panel.appendChild(item);
            });

            let batal=document.createElement("div");
            batal.className="batal-btn-overlay";
            batal.innerText="Batal";
            batal.onclick=tutupOverlay;
            panel.appendChild(batal);

            ov.style.display="block";
        }

        function pilihNama(nama){
            if(mode==="absen"){
                const waktuSekarang = new Date().toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' });
                absen(nama, todayDate(), waktuSekarang);
                tutupOverlay();
            } else if(mode==="gantikan1"){
                pengganti=nama;
                mode="gantikan2";
                tampilOverlayPilih(karyawan.filter(x=>x!==nama),"Pilih yang Digantikan");
            } else if(mode==="gantikan2"){
                gantikan(pengganti,nama,todayDate(), new Date().toLocaleTimeString('id-ID', {hour12:false, hour:'2-digit', minute:'2-digit'}));
                tutupOverlay();
            } else if(mode==="gantikanQuick"){
                // Quick flow: pilih pengganti dulu, lalu pilih digantikan
                pengganti = nama;
                mode = "gantikanQuick2";
                const remaining = karyawan.filter(x=>x!==pengganti);
                tampilOverlayPilih(remaining, "Pilih yang Digantikan (yang tidak hadir)");
            } else if(mode==="gantikanQuick2"){
                const dig = nama;
                gantikan(pengganti,dig,todayDate(), new Date().toLocaleTimeString('id-ID', {hour12:false, hour:'2-digit', minute:'2-digit'}));
                tutupOverlay();
            } else if(mode==="filter"){
                filterRiwayat(nama);
            }
        }

        // ----------------------------
        // RESET DATA
        // ----------------------------
        function resetData(){
            if(confirm("Yakin reset SEMUA data absensi dan jadwal ke default? Tindakan ini tidak bisa dibatalkan.")){
                data=[];
                localStorage.removeItem("absensi");
                localStorage.removeItem("jadwalMingguan");
                JadwalMingguan = loadJadwal();
                filterAktif = "Semua Karyawan";
                tampilkan();
                showToast("Data absensi & jadwal dikembalikan ke setelan awal.");
            }
        }

        // ----------------------------
        // LAPORAN & EKSPOR CSV
        // ----------------------------
        function tampilkanLaporanBulanan() {
            let ov = document.getElementById("overlay");
            const today = new Date();

            ov.innerHTML = `
                <div class="panel">
                    <h3 style="margin-top:0;">🧾 Laporan Absensi Bulanan</h3>
                    <div id="laporan-controls">
                        <label for="bulan-tahun">Pilih Bulan:</label>
                        <select id="bulan-tahun" onchange="prosesLaporanBulanan()">
                            ${Array.from({length: 12}).map((_, i) => {
                                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                                const year = d.getFullYear();
                                const month = d.getMonth() + 1;
                                const monthName = d.toLocaleDateString('id-ID', { month: 'long' });
                                const val = `${year}-${String(month).padStart(2, '0')}`;
                                const selected = (i === 0) ? 'selected' : '';
                                return `<option value="${val}" ${selected}>${monthName} ${year}</option>`;
                            }).join('')}
                        </select>
                        <button onclick="eksporDataCSV(document.getElementById('bulan-tahun').value)">⬇️ Ekspor CSV Bulan Ini</button>
                    </div>
                    <div id="hasil-laporan" style="margin-top: 16px;"></div>

                    <div class="batal-btn-overlay" onclick="tutupOverlay()" style="margin-top:12px;">Tutup Laporan</div>
                </div>
            `;
            prosesLaporanBulanan(document.getElementById('bulan-tahun').value);
            ov.style.display="block";
        }

        function prosesLaporanBulanan(bulanTahun = null) {
            if (!bulanTahun) {
                bulanTahun = document.getElementById('bulan-tahun').value;
            }
            
            const [tahun, bulan] = bulanTahun.split('-').map(Number);
            const hasilLaporanDiv = document.getElementById('hasil-laporan');
            
            const dataBulanIni = data.filter(d => {
                const [dYear, dMonth] = d.tanggal.split('-').map(Number);
                return dYear === tahun && dMonth === bulan;
            });

            const stats = {};
            karyawan.forEach(nama => {
                stats[nama] = { hadir: 0, terlambat: 0, digantikan: 0, menggantikan: 0 };
            });

            dataBulanIni.forEach(d => {
                if (d.jenis === "Absen") {
                    if (stats[d.nama]) stats[d.nama].hadir++;
                } else if (d.jenis === "Gantikan") {
                    if (stats[d.pengganti]) stats[d.pengganti].menggantikan++;
                    if (stats[d.digantikan]) stats[d.digantikan].digantikan++;
                }
            });

            let html = `<table style="width:100%; border-collapse: collapse; margin-top: 8px;">
                <thead>
                    <tr style="background-color: var(--accent-primary); color: white;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Nama</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Hadir</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Ganti (+/-)</th>
                    </tr>
                </thead>
                <tbody>`;

            karyawan.forEach(nama => {
                const stat = stats[nama];
                html += `
                    <tr style="background-color: var(--card);">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${nama}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${stat.hadir}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--accent-orange); font-weight: bold;">+${stat.menggantikan} / -${stat.digantikan}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            hasilLaporanDiv.innerHTML = html;
        }

        function eksporDataCSV(bulanTahun) {
            const [tahun, bulan] = bulanTahun.split('-').map(Number);
            const dataMentahBulanIni = data.filter(d => {
                const [dYear, dMonth] = d.tanggal.split('-').map(Number);
                return dYear === tahun && dMonth === bulan;
            });

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tanggal,Jenis,Nama/Pengganti,Waktu,Status/Digantikan\n";

            dataMentahBulanIni.forEach(d => {
                let baris = "";
                if (d.jenis === "Absen") {
                    baris = `${d.tanggal},${d.jenis},${d.nama},${d.waktu},${d.status || ''}`;
                } else if (d.jenis === "Gantikan") {
                    baris = `${d.tanggal},${d.jenis},${d.pengganti},${d.waktu},Menggantikan ${d.digantikan}`;
                }
                csvContent += baris + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Laporan_Absensi_${bulanTahun}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast(`⬇️ Data bulan ${bulanTahun} berhasil diekspor.`);
        }

        // ----------------------------
        // RANKING & STATUS JADWAL
        // ----------------------------
        function tampilkanRanking() {
            let ov = document.getElementById("overlay");
            ov.innerHTML = `<div class="panel"><h3 style="margin-top:0;">🏆 Statistik Absensi Total</h3></div>`;
            const panel = ov.querySelector('.panel');

            const stats = {};
            karyawan.forEach(nama => {
                stats[nama] = { hadir: 0, terlambat: 0, digantikan: 0, menggantikan: 0, totalAbsensi: 0 };
            });

            data.forEach(d => {
                if (d.jenis === "Absen") {
                    if (stats[d.nama]) {
                        stats[d.nama].hadir++;
                        stats[d.nama].totalAbsensi++;
                    }
                } else if (d.jenis === "Gantikan") {
                    if (stats[d.pengganti]) {
                        stats[d.pengganti].menggantikan++;
                        stats[d.pengganti].totalAbsensi++;
                    }
                    if (stats[d.digantikan]) {
                        stats[d.digantikan].digantikan++;
                    }
                }
            });

            const ranking = Object.keys(stats).map(nama => ({ nama, ...stats[nama] }))
                .sort((a,b)=> {
                    if (b.totalAbsensi !== a.totalAbsensi) return b.totalAbsensi - a.totalAbsensi;
                    return a.terlambat - b.terlambat;
                });

            let html = `<table style="width:100%; border-collapse: collapse; margin-top: 8px;">
                <thead>
                    <tr style="background-color: var(--accent-primary); color: white;">
                        <th style="padding: 10px; border: 1px solid #ddd;">Nama</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Ganti (-/+)</th>
                    </tr>
                </thead>
                <tbody>`;

            ranking.forEach((r, index) => {
                const warnaRow = (index === 0) ? "background-color: #ffe0b2;" : "background-color: var(--card);";
                html += `
                    <tr style="${warnaRow}">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${index + 1}. ${r.nama}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${r.totalAbsensi}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--accent-orange);">-${r.digantikan} / +${r.menggantikan}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            panel.innerHTML += html;

            let batal=document.createElement("div");
            batal.className="batal-btn-overlay";
            batal.innerText="Tutup Ranking";
            batal.onclick=tutupOverlay;
            panel.appendChild(batal);

            ov.style.display="block";
        }

        // STATUS JADWAL + FITUR GANTI JADWAL
        function tampilkanStatus() {
            let ov = document.getElementById("overlay");
            const hariIni = getTodayDayName();
            const jadwalHariIni = JadwalMingguan[hariIni] || [];
            const hadirHariIni = data
                .filter(d => d.tanggal === todayDate() && d.jenis === "Absen")
                .map(d => d.nama);
            
            ov.innerHTML = `<div class="panel"><h3 style="margin-top:0;">📋 Status Jadwal Hari Ini (${hariIni})</h3></div>`;
            const panel = ov.querySelector('.panel');

            // Status Ringkas Hari Ini per karyawan (berdasarkan keseluruhan karyawan)
            karyawan.forEach(nama => {
                let statusClass = '';
                let statusText = '';

                const isDijadwalkan = (JadwalMingguan[getTodayDayName()] || []).includes(nama);
                const isHadir = hadirHariIni.includes(nama);
                const isMenggantikan = data.some(d => d.tanggal === todayDate() && d.pengganti === nama && d.jenis === "Gantikan");
                const isDigantikan = data.some(d => d.tanggal === todayDate() && d.digantikan === nama && d.jenis === "Gantikan");

                if (isHadir) {
                    statusClass = 'status-hadir';
                    const waktuAbsen = data.find(d => d.tanggal === todayDate() && d.nama === nama && d.jenis === "Absen").waktu;
                    statusText = `Absen Hadir (${waktuAbsen})`;
                } else if (isMenggantikan) {
                    const digantikan = data.find(d => d.tanggal === todayDate() && d.pengganti === nama && d.jenis === "Gantikan").digantikan;
                    statusClass = 'status-hadir'; 
                    statusText = `Menggantikan ${digantikan}`;
                } else if (isDigantikan) {
                    const pengganti = data.find(d => d.tanggal === todayDate() && d.digantikan === nama && d.jenis === "Gantikan").pengganti;
                    statusClass = 'status-seharusnya-hadir'; 
                    statusText = `Digantikan oleh ${pengganti}`;
                } else if (isDijadwalkan) {
                    statusClass = 'status-belum-hadir';
                    statusText = 'BELUM HADIR (Dijadwalkan)';
                } else {
                    statusClass = '';
                    statusText = 'Tidak Dijadwalkan / Tidak Absen';
                }

                let item=document.createElement("div");
                item.className=`list-item ${statusClass}`;
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.innerHTML = `<div style="display:flex; gap:10px; align-items:center;"><span style="font-weight:700">${nama}</span><small style="color:var(--muted)">${statusText}</small></div>
                                  <div style="display:flex; gap:8px; align-items:center;">
                                    <button onclick="gantiJadwal('${nama}')" style="padding:6px 8px; border-radius:8px; border:none; cursor:pointer; background:#f0f0f0; font-weight:700;">🔄 Ganti Jadwal</button>
                                  </div>`;
                panel.appendChild(item);
            });

            // Tampilkan jadwal mingguan lengkap + tombol edit ringkas per hari
            let jadwalHtml = `<h4 style="margin-top:16px; color: var(--accent-primary);">Jadwal Reguler Minggu Ini:</h4>`;
            Object.keys(JadwalMingguan).forEach(hari => {
                jadwalHtml += `<div style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1;"><strong>${hari}:</strong> ${JadwalMingguan[hari].join(', ') || '<i>Tidak ada</i>'}</div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="editHari('${hari}')" style="padding:6px 8px; border-radius:8px; border:none; cursor:pointer; background:#fff0d9; font-weight:700;">✏️ Edit</button>
                    </div>
                </div>`;
            });

            panel.innerHTML += jadwalHtml;

            let batal=document.createElement("div");
            batal.className="batal-btn-overlay";
            batal.innerText="Tutup Status";
            batal.onclick=tutupOverlay;
            panel.appendChild(batal);
            
            ov.style.display="block";
        }

        // Fungsi untuk membuka overlay mengganti jadwal untuk satu nama
        function gantiJadwal(nama){
            const ov = document.getElementById("overlay");
            ov.innerHTML = `<div class="panel"><h3 style="margin-top:0;">🔄 Ganti Jadwal — ${nama}</h3></div>`;
            const panel = ov.querySelector('.panel');

            // Pilih hari saat ini (jika ada) dan hari tujuan
            const hariSekarang = Object.keys(JadwalMingguan).find(h => (JadwalMingguan[h] || []).includes(nama)) || "Tidak Dijadwalkan";
            const opsiHari = Object.keys(JadwalMingguan).map(h => `<option value="${h}">${h}</option>`).join('');

            panel.innerHTML += `
                <p style="margin:6px 0 12px 0; color:var(--muted)">Saat ini: <strong>${hariSekarang}</strong></p>
                <label>Pindahkan ke hari lain:</label>
                <select id="tujuan-hari">${opsiHari}</select>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button id="btn-pindah" style="flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer; background:var(--accent-primary); color:white; font-weight:700;">Pindahkan</button>
                    <button id="btn-hapus" style="flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer; background:var(--accent-red); color:white; font-weight:700;">Hapus dari Jadwal</button>
                </div>
                <div style="margin-top:10px;">
                    <button class="batal-btn-overlay" id="btn-batal">Batal</button>
                </div>
            `;

            document.getElementById('btn-batal').onclick = tutupOverlay;
            document.getElementById('btn-pindah').onclick = ()=>{
                const tujuan = document.getElementById('tujuan-hari').value;
                if(!tujuan){ showToast('Pilih hari tujuan'); return; }
                // Hapus dari hari lama
                Object.keys(JadwalMingguan).forEach(h=>{
                    JadwalMingguan[h] = (JadwalMingguan[h] || []).filter(x => x !== nama);
                });
                // Add to tujuan if not exists
                if(!JadwalMingguan[tujuan]) JadwalMingguan[tujuan] = [];
                if(!JadwalMingguan[tujuan].includes(nama)) JadwalMingguan[tujuan].push(nama);
                saveJadwal(JadwalMingguan);
                showToast(`${nama} dipindahkan ke ${tujuan}.`);
                tutupOverlay();
                // refresh status jika overlay sebelumnya ditutup
                tampilkan();
            };

            document.getElementById('btn-hapus').onclick = ()=>{
                if(!confirm(`Hapus ${nama} dari semua jadwal?`)) return;
                Object.keys(JadwalMingguan).forEach(h=>{
                    JadwalMingguan[h] = (JadwalMingguan[h] || []).filter(x => x !== nama);
                });
                saveJadwal(JadwalMingguan);
                showToast(`${nama} dihapus dari jadwal.`);
                tutupOverlay();
                tampilkan();
            };

            ov.style.display = 'block';
        }

        // Edit per hari (tampilkan list & bisa tambah/hapus orang dari hari tersebut)
        function editHari(hari){
            const ov = document.getElementById("overlay");
            ov.innerHTML = `<div class="panel"><h3 style="margin-top:0;">✏️ Edit Jadwal — ${hari}</h3></div>`;
            const panel = ov.querySelector('.panel');

            // Pilihan karyawan yang belum ada di hari ini
            const ada = new Set(JadwalMingguan[hari] || []);
            const opsiTambah = karyawan.filter(n => !ada.has(n)).map(n => `<option value="${n}">${n}</option>`).join('');

            panel.innerHTML += `
                <p style="margin:6px 0 10px 0;"><strong>Yang dijadwalkan:</strong> ${(JadwalMingguan[hari]||[]).join(', ') || '<i>Tidak ada</i>'}</p>
                <label>Tambah Karyawan ke ${hari}:</label>
                <select id="tambah-ke-hari"><option value="">-- Pilih --</option>${opsiTambah}</select>
                <button id="btn-tambah" style="margin-top:8px; padding:10px; border-radius:8px; border:none; cursor:pointer; background:var(--accent-green); color:white; font-weight:700;">Tambah</button>

                <h4 style="margin-top:14px;">Hapus dari hari ini:</h4>
                <div id="list-hapus" style="margin-top:8px;"></div>

                <div style="margin-top:12px;">
                    <button class="batal-btn-overlay" id="btn-tutup-edit">Tutup</button>
                </div>
            `;

            const listHapus = panel.querySelector('#list-hapus');
            (JadwalMingguan[hari] || []).forEach(n=>{
                let el = document.createElement('div');
                el.style.display = 'flex';
                el.style.justifyContent = 'space-between';
                el.style.padding = '8px';
                el.style.border = '1px solid #f0f0f0';
                el.style.borderRadius = '8px';
                el.style.marginBottom = '8px';
                el.innerHTML = `<div style="font-weight:700">${n}</div><button style="background:#ff5959;color:white;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;" onclick="hapusDariHari('${hari}','${n}')">Hapus</button>`;
                listHapus.appendChild(el);
            });

            document.getElementById('btn-tambah').onclick = ()=>{
                const pilih = document.getElementById('tambah-ke-hari').value;
                if(!pilih) { showToast('Pilih karyawan untuk ditambahkan.'); return; }
                if(!JadwalMingguan[hari]) JadwalMingguan[hari] = [];
                if(!JadwalMingguan[hari].includes(pilih)) JadwalMingguan[hari].push(pilih);
                saveJadwal(JadwalMingguan);
                showToast(`${pilih} ditambahkan ke ${hari}.`);
                tutupOverlay();
                tampilkan();
            };

            document.getElementById('btn-tutup-edit').onclick = tutupOverlay;
            ov.style.display = 'block';
        }

        function hapusDariHari(hari,nama){
            if(!confirm(`Hapus ${nama} dari ${hari}?`)) return;
            JadwalMingguan[hari] = (JadwalMingguan[hari] || []).filter(x=>x!==nama);
            saveJadwal(JadwalMingguan);
            showToast(`${nama} dihapus dari ${hari}.`);
            tutupOverlay();
            tampilkan();
        }

        // ----------------------------
        // STATUS RINGKAS
        // ----------------------------
        function updateStatusRingkas() {
            const statusDiv = document.getElementById('status-ringkas');
            const hariIni = getTodayDayName();
            const tanggalAbsen = todayDate();
            const jadwalHariIni = JadwalMingguan[hariIni] || [];
            
            const absensiHariIni = data.filter(d => d.tanggal === tanggalAbsen && d.jenis === "Absen");
            const hadir = absensiHariIni.length;
            const belumAbsenDijadwalkan = jadwalHariIni.filter(nama => !absensiHariIni.some(d => d.nama === nama)).length;

            let statusText = `${hariIni} (${tanggalAbsen}) | Hadir: ${hadir} ${belumAbsenDijadwalkan > 0 ? `| Belum Absen: ${belumAbsenDijadwalkan}` : ''}`;

            if (hadir === jadwalHariIni.length && belumAbsenDijadwalkan === 0 && jadwalHariIni.length > 0) {
                statusText = `✅ ${hariIni}: Semua ${hadir} Karyawan Dijadwalkan Sudah Absen!`;
            } else if (jadwalHariIni.length === 0) {
                statusText = `${hariIni}: Tidak Ada Jadwal Reguler. ${hadir} Absen Manual.`;
            }

            statusDiv.innerHTML = statusText;
        }

        // INISIALISASI
        document.addEventListener('DOMContentLoaded', () => {
            tampilkan();
        });
    </script>
</body>
</html>