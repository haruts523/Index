<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Absensi Angkringan Modern</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2B6CB0">
<style>
  :root{
    --bg: #f3f6fa;
    --card: #ffffff;
    --text: #0f1724;
    --muted: rgba(15,23,36,0.6);

    --accent-gradient: linear-gradient(135deg,#2B6CB0 0%, #4C7CBD 100%);
    --accent-start: #2B6CB0;
    --accent-end: #4C7CBD;

    --accent-red: #ff4d4d;
    --accent-green: #2F855A;
    --accent-orange: #ED8936;

    --soft-shadow: 0 6px 20px rgba(16,24,40,0.06);
    font-family: Inter, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    display:flex;
    justify-content:center;
    padding:18px;
    min-height:100vh;
    background-size:cover;
    background-attachment:fixed;
  }
  .app{ width:100%; max-width:920px; margin:0 auto; }

  .banner{
    border-radius:14px;
    padding:22px;
    color:white;
    background: var(--accent-gradient);
    box-shadow: var(--soft-shadow);
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    margin-bottom:16px;
  }
  .banner h1{ margin:0; font-size:20px; letter-spacing:0.4px; }
  .banner .sub{ font-size:13px; opacity:0.95 }

  .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); margin-bottom:16px; }
  .card-action{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    font-weight:700;
    text-align:center;
    cursor:pointer;
    transition: transform .14s ease, box-shadow .14s ease;
    box-shadow: 0 6px 14px rgba(16,24,40,0.04);
    user-select:none;
  }
  .card-action:active{
    transform: translateY(2px) scale(.995);
    box-shadow: 0 0 18px rgba(43,108,176,0.12);
  }
  .card-action.small{ padding:10px; font-weight:600; }

  .big-action{
    grid-column: 1 / -1;
    font-size: 18px;
    font-weight: 800;
    padding: 22px;
    color: white;
    background: var(--accent-gradient);
    border: none;
    box-shadow: 0 6px 16px rgba(43,108,176,0.28);
  }
  .big-action:active{
    transform: scale(0.97);
    box-shadow: 0 0 18px rgba(43,108,176,0.28);
  }

  .section-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin:12px 0; }
  .section-title{ color:var(--accent-start); font-weight:800; cursor:pointer; }

  #riwayat{ margin-bottom:24px; }
  .riwayat-item{
    background:var(--card);
    border-radius:10px;
    padding:12px;
    box-shadow: 0 6px 12px rgba(16,24,40,0.04);
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .riwayat-item .meta{ color:var(--muted); font-size:13px; }
  .btn-icon{ background:none; border:none; cursor:pointer; font-size:16px; }

  #overlay{
    display:none;
    position:fixed; inset:0;
    z-index:2000;
    background: rgba(255,255,255,0.96);
    padding:20px;
    overflow:auto;
  }
  .overlay-inner{ max-width:820px; margin:0 auto; }
  .list-item{
    background:var(--card);
    padding:12px;
    border-radius:10px;
    margin-bottom:8px;
    cursor:pointer;
    display:flex; justify-content:space-between; align-items:center;
    box-shadow: 0 4px 10px rgba(16,24,40,0.04);
  }
  .batal-btn-overlay{
    margin-top:12px;
    background:var(--accent-red);
    color:white;
    padding:12px;
    border-radius:10px;
    text-align:center;
    cursor:pointer;
    font-weight:700;
  }

  table{ width:100%; border-collapse:collapse; margin-top:12px; background:transparent;}
  table th, table td{ padding:8px 10px; text-align:left; border-bottom:1px solid #eef2f7; font-size:14px; }

  #toast{
    visibility:hidden;
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:26px; z-index:3000; background:#222; color:#fff; padding:12px 18px; border-radius:10px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.18);
  }
  #toast.show{ visibility:visible; animation: fadein .3s, fadeout .3s 2.5s; }
  @keyframes fadein{ from{ opacity:0; transform:translate(-50%,8px)} to{opacity:1; transform:translate(-50%,0)}}
  @keyframes fadeout{ to{ opacity:0} }

  @media (max-width:520px){
    .banner{ flex-direction:column; align-items:flex-start; gap:6px; }
  }

  .muted{ color:var(--muted); font-size:13px; }
  .pill{ background:rgba(0,0,0,0.06); padding:6px 8px; border-radius:8px; font-size:13px; }

  .dark-body{ background:#0b1220 !important; color:#e6eefb !important; }
  .dark-card{ background:#11151a !important; color:#e6eefb !important; box-shadow:none !important; }

  label{ display:block; margin-top:8px; font-weight:600; }
  input[type="text"], input[type="date"], input[type="time"], select, textarea{
    width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; margin-top:6px; font-size:14px;
  }
  .row{ display:flex; gap:8px; }
  .col{ flex:1; }

  .day-box{ background:var(--card); padding:10px; border-radius:8px; margin-bottom:8px; box-shadow: 0 3px 8px rgba(16,24,40,0.03); }
  .small-muted{ font-size:12px; color:var(--muted); }

  /* small tweaks for tab buttons */
  #pengaturan-body .card-action.small{ background:transparent; border:1px solid rgba(0,0,0,0.04); }
</style>
</head>
<body>
  <div class="app">
    <div class="banner">
      <div>
        <h1>ABSENSI ANGRINGAN</h1>
        <div class="sub">Absen bebas ‚Äî bisa kapan saja</div>
      </div>
      <div style="text-align:right">
        <div id="status-ringkas" class="pill">Memuat status...</div>
        <div style="height:6px"></div>
        <div class="muted" style="font-size:12px">Pengaturan: <span id="current-theme">Default</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="card-action big-action" onclick="mulaiAbsen()">üëã Absen Sekarang</div>
      <div class="card-action" onclick="mulaiAbsenTanggalLain()">üóìÔ∏è Absen Tanggal Lain</div>
      <div class="card-action" onclick="mulaiGantikan()">üîÅ Gantikan</div>
      <div class="card-action" onclick="tampilkanRanking()">üèÜ Statistik Total</div>
      <div class="card-action" onclick="tampilkanLaporanBulanan()">üßæ Laporan Bulanan</div>
      <div class="card-action" onclick="tampilkanStatus()">üìã Status</div>
      <div class="card-action" onclick="tampilkanPengaturan()">‚öôÔ∏è Pengaturan</div>
    </div>

    <div class="section-row">
      <div class="section-title" onclick="mulaiFilterRiwayat()">Riwayat Absensi (<span id="filter-status">Semua</span>)</div>
      <div style="display:flex; gap:8px; align-items:center">
        <select id="sort-riwayat" onchange="tampilkan()" class="pill">
          <option value="terbaru">Terbaru</option>
          <option value="terlama">Terlama</option>
          <option value="nama_asc">Nama (A-Z)</option>
        </select>
        <button class="card-action small" onclick="tampilkanLaporanBulanan()">Lihat Laporan</button>
      </div>
    </div>

    <div id="riwayat"></div>
  </div>

  <div id="overlay"><div class="overlay-inner"></div></div>
  <div id="toast"></div>

<script>
// ===================== Storage keys & defaults =====================
const STORAGE_ABSENSI = 'absensi';
const STORAGE_KARYAWAN = 'karyawan';
const STORAGE_THEME = 'theme';
const STORAGE_BG = 'backgroundImage';
const STORAGE_JADWAL = 'jadwalMingguan';
const STORAGE_SETTINGS = 'appSettings';

// initial data (load from localStorage)
let data = JSON.parse(localStorage.getItem(STORAGE_ABSENSI) || '[]');
let karyawan = JSON.parse(localStorage.getItem(STORAGE_KARYAWAN) || '["Lala","Zaki","Kemi","Haris","Izzul","Fawaz"]');

// Jadwal mingguan: load or initialize
let jadwalMingguan = JSON.parse(localStorage.getItem(STORAGE_JADWAL) || 'null');
if(!jadwalMingguan){
  jadwalMingguan = {
    "Senin": [],
    "Selasa": [],
    "Rabu": [],
    "Kamis": [],
    "Jumat": [],
    "Sabtu": [],
    "Minggu": []
  };
  localStorage.setItem(STORAGE_JADWAL, JSON.stringify(jadwalMingguan));
}

// settings
let settings = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || 'null');
if(!settings){
  settings = {
    batasAbsenAktif: false,
    batasAbsenJam: '09:00',
    notifikasiSuara: true
  };
  localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
}

let mode = null;
let pengganti = null;
let filterAktif = "Semua";
let savedTheme = localStorage.getItem(STORAGE_THEME) || 'blue';
let savedBg = localStorage.getItem(STORAGE_BG) || null;

// ===================== Utilities =====================
function todayDate(){ return new Date().toISOString().slice(0,10); }
function nowTime(){ return new Date().toLocaleTimeString('id-ID',{hour12:false,hour:'2-digit',minute:'2-digit'}); }
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.className='show'; setTimeout(()=>t.className='',(3000)); }
function tutupOverlay(){ document.getElementById('overlay').style.display='none'; document.querySelector('#overlay .overlay-inner').innerHTML=''; mode=null; pengganti=null; }

// Play short click sound using Web Audio (no file needed)
function playClick(){
  try{
    const s = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || '{}');
    if(s && s.notifikasiSuara === false) return;
  }catch(e){}
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'square';
    o.frequency.value = 1000;
    g.gain.value = 0.00001;
    o.connect(g); g.connect(ctx.destination);
    const now = ctx.currentTime;
    g.gain.setValueAtTime(0.00001, now);
    g.gain.exponentialRampToValueAtTime(0.05, now + 0.001);
    o.start(now);
    g.gain.exponentialRampToValueAtTime(0.00001, now + 0.06);
    o.stop(now + 0.07);
    // close context shortly after
    setTimeout(()=>{ try{ ctx.close(); }catch(e){} }, 120);
  }catch(err){}
}

// ===================== Render Riwayat =====================
function tampilkan(){
  const wrap = document.getElementById('riwayat');
  wrap.innerHTML = '';
  document.getElementById('filter-status').textContent = filterAktif;

  let arr = data.slice();
  if(filterAktif !== 'Semua'){
    arr = arr.filter(d => (d.jenis === 'Absen' && d.nama === filterAktif) || (d.jenis === 'Gantikan' && (d.pengganti === filterAktif || d.digantikan === filterAktif)));
  }

  const sort = document.getElementById('sort-riwayat').value;
  arr.sort((a,b)=>{
    const ta = new Date((a.tanggal||'1970-01-01') + 'T' + (a.waktu||'00:00')).getTime();
    const tb = new Date((b.tanggal||'1970-01-01') + 'T' + (b.waktu||'00:00')).getTime();
    if(sort === 'terbaru') return tb - ta;
    if(sort === 'terlama') return ta - tb;
    if(sort === 'nama_asc') return (a.nama||a.pengganti||'').localeCompare(b.nama||b.pengganti||'');
    return tb - ta;
  });

  if(arr.length === 0){
    wrap.innerHTML = '<p class="muted" style="text-align:center">Belum ada riwayat untuk filter ini.</p>';
    updateStatusRingkas();
    return;
  }

  arr.forEach(entry => {
    const box = document.createElement('div'); box.className = 'riwayat-item';
    const left = document.createElement('div');
    if(entry.jenis === 'Absen'){
      left.innerHTML = `<strong>${entry.nama}</strong> <div class="small-muted">(Absen)</div><div class="meta">${entry.tanggal} ‚Ä¢ ${entry.waktu}</div>`;
    } else {
      left.innerHTML = `<strong>${entry.pengganti}</strong> <div class="small-muted">ganti ${entry.digantikan}</div><div class="meta">${entry.tanggal} ‚Ä¢ ${entry.waktu}</div>`;
    }
    const right = document.createElement('div');
    const del = document.createElement('button'); del.className='btn-icon'; del.innerText='‚ùå'; del.title='Hapus entri';
    del.onclick = ()=>hapusRiwayat(entry);
    right.appendChild(del);
    box.appendChild(left); box.appendChild(right);
    wrap.appendChild(box);
  });

  updateStatusRingkas();
}

function hapusRiwayat(obj){
  if(!confirm('Yakin menghapus entri ini?')) return;
  data = data.filter(d => JSON.stringify(d) !== JSON.stringify(obj));
  localStorage.setItem(STORAGE_ABSENSI, JSON.stringify(data));
  tampilkan();
  showToast('Entri dihapus');
}

// ===================== Absen (core + wrapper untuk batas waktu & suara) =====================
function coreAbsen(nama, tanggal, waktu){
  // prevent duplicate same person same date
  if(data.some(d => d.jenis === 'Absen' && d.nama === nama && d.tanggal === tanggal)){
    showToast(`${nama} sudah terdaftar hadir pada ${tanggal}`);
    return;
  }
  const entry = { jenis: 'Absen', nama, tanggal, waktu };
  data.push(entry);
  localStorage.setItem(STORAGE_ABSENSI, JSON.stringify(data));
  tampilkan();
  showToast(`${nama} berhasil absen`);
}

function absen(nama, tanggal, waktu){
  // check batas waktu
  const s = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || '{}');
  if(s && s.batasAbsenAktif && tanggal === todayDate()){
    const batas = s.batasAbsenJam || '09:00';
    const wShort = (waktu||'00:00').slice(0,5);
    if(wShort > batas){
      showToast(`Absen diblokir ‚Äî lewat batas waktu (${batas})`);
      return;
    }
  }
  // play click if allowed
  try{ if(settings.notifikasiSuara) playClick(); }catch(e){}
  coreAbsen(nama, tanggal, waktu);
}

function mulaiAbsen(){
  mode = 'absen';
  const hadirHariIni = data.filter(d => d.tanggal === todayDate() && d.jenis === 'Absen').map(d => d.nama);
  tampilOverlayPilih(karyawan, 'üëã Pilih Karyawan yang Absen', hadirHariIni);
}

function mulaiAbsenTanggalLain(){
  mode = 'absenLain';
  const ovInner = document.querySelector('#overlay .overlay-inner');
  ovInner.innerHTML = `
    <h3>üóìÔ∏è Absen Tanggal & Waktu Lain</h3>
    <label>Pilih Karyawan:</label>
    <select id="absen-lain-nama">${karyawan.map(n=>`<option value="${n}">${n}</option>`).join('')}</select>
    <label>Tanggal (maks hari ini):</label>
    <input type="date" id="absen-lain-tgl" max="${todayDate()}" value="${todayDate()}">
    <label>Waktu:</label>
    <input type="time" id="absen-lain-wkt" value="${nowTime()}">
    <div style="margin-top:12px"><button class="card-action" id="simpan-absen-lain">Simpan Absen</button></div>
  `;
  document.getElementById('simpan-absen-lain').onclick = ()=>{
    const nama = document.getElementById('absen-lain-nama').value;
    const tgl = document.getElementById('absen-lain-tgl').value;
    const wkt = document.getElementById('absen-lain-wkt').value;
    if(!nama || !tgl || !wkt){ showToast('Lengkapi data absen'); return; }
    absen(nama, tgl, wkt);
    tutupOverlay();
  };
  const b = document.createElement('div'); b.className='batal-btn-overlay'; b.innerText='Batal'; b.onclick=tutupOverlay;
  ovInner.appendChild(b);
  document.getElementById('overlay').style.display = 'block';
}

function tampilOverlayPilih(list, judul, hadirList = []){
  const ovInner = document.querySelector('#overlay .overlay-inner');
  ovInner.innerHTML = `<h3>${judul}</h3>`;
  list.forEach(name=>{
    const el = document.createElement('div'); el.className='list-item';
    const sudah = hadirList.includes(name);
    el.innerHTML = `<div>${name}</div><div class="muted">${sudah ? 'Sudah' : 'Pilih'}</div>`;
    if(!sudah) el.onclick = ()=>pilihNama(name);
    else { el.style.cursor='not-allowed'; el.style.opacity=0.6; }
    ovInner.appendChild(el);
  });
  const b = document.createElement('div'); b.className='batal-btn-overlay'; b.innerText='Batal'; b.onclick=tutupOverlay;
  ovInner.appendChild(b);
  document.getElementById('overlay').style.display = 'block';
}

function pilihNama(nama){
  if(mode === 'absen'){
    absen(nama, todayDate(), nowTime());
  } else if(mode === 'gantikan1'){
    pengganti = nama;
    mode = 'gantikan2';
    const others = karyawan.filter(k => k !== pengganti);
    tampilOverlayPilih(others, `üîÅ ${pengganti} menggantikan siapa?`);
    return;
  } else if(mode === 'gantikan2'){
    // fallback
    gantikan(pengganti, nama);
  }
  tutupOverlay();
}

// ===================== Gantikan =====================
function mulaiGantikan(){
  mode = 'gantikan1';
  tampilOverlayPilih(karyawan, 'üîÅ Siapa yang Menggantikan?');
}

function gantikan(penggantiNama, digantikanNama){
  if(!penggantiNama || !digantikanNama){ showToast('Pilihan pengganti/digantikan tidak valid'); return; }
  data.push({ jenis: 'Gantikan', pengganti: penggantiNama, digantikan: digantikanNama, tanggal: todayDate(), waktu: nowTime() });
  localStorage.setItem(STORAGE_ABSENSI, JSON.stringify(data));
  tampilkan();
  showToast(`${penggantiNama} menggantikan ${digantikanNama}`);
  tutupOverlay();
}

// ===================== Reset Data (used elsewhere) =====================
function resetAllData(){
  if(!confirm('Yakin menghapus semua data absensi?')) return;
  data = [];
  localStorage.removeItem(STORAGE_ABSENSI);
  tampilkan();
  showToast('Semua data absensi dihapus');
}

// ===================== Laporan Bulanan (dengan Export + Reset) =====================
function tampilkanLaporanBulanan(){
  const ovInner = document.querySelector('#overlay .overlay-inner');
  const now = new Date();
  let options = '';
  for(let i=0;i<12;i++){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    options += `<option value="${val}" ${i===0?'selected':''}>${d.toLocaleDateString('id-ID',{month:'long', year:'numeric'})}</option>`;
  }
  ovInner.innerHTML = `
    <h3>üßæ Laporan Bulanan</h3>
    <label>Pilih Bulan:</label>
    <select id="lap-bulan">${options}</select>
    <div id="hasil-laporan" style="margin-top:12px"></div>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="card-action" id="export-csv">‚¨áÔ∏è Ekspor CSV Bulan Ini</button>
      <button class="card-action" id="reset-data-small" style="background:#ffcccb; color:#000">‚ö†Ô∏è Reset Data</button>
    </div>
  `;
  document.getElementById('export-csv').onclick = eksportCSVFromLaporan;
  document.getElementById('reset-data-small').onclick = ()=>{
    if(confirm('Reset semua data absensi?')){
      resetAllData();
      tutupOverlay();
    }
  };
  document.getElementById('overlay').style.display = 'block';
  prosesLaporanBulanan();
}

function prosesLaporanBulanan(){
  const sel = document.getElementById('lap-bulan');
  if(!sel) return;
  const val = sel.value; const [y,m] = val.split('-'); const prefix = `${y}-${m}`;
  const dataBulan = data.filter(d => d.tanggal && d.tanggal.startsWith(prefix));
  const stats = {};
  karyawan.forEach(k => stats[k] = { hadir:0, menggantikan:0, digantikan:0 });
  dataBulan.forEach(d=>{
    if(d.jenis === 'Absen' && stats[d.nama]) stats[d.nama].hadir++;
    if(d.jenis === 'Gantikan'){
      if(stats[d.pengganti]) stats[d.pengganti].menggantikan++;
      if(stats[d.digantikan]) stats[d.digantikan].digantikan++;
    }
  });
  const hasil = document.getElementById('hasil-laporan');
  if(dataBulan.length === 0){
    hasil.innerHTML = `<p class="muted">Tidak ada data untuk bulan ini.</p>`;
    return;
  }
  let html = `<table><thead><tr><th>Nama</th><th>Hadir</th><th>Ganti</th><th>Diganti</th></tr></thead><tbody>`;
  karyawan.forEach(k=>{
    const s = stats[k];
    html += `<tr><td>${k}</td><td>${s.hadir}</td><td>${s.menggantikan}</td><td>${s.digantikan}</td></tr>`;
  });
  html += `</tbody></table>`;
  hasil.innerHTML = html;
}

function eksportCSVFromLaporan(){
  const sel = document.getElementById('lap-bulan');
  if(!sel){ showToast('Pilih bulan dulu'); return; }
  const prefix = sel.value;
  const dataBulan = data.filter(d => d.tanggal && d.tanggal.startsWith(prefix));
  if(dataBulan.length === 0){ showToast('Tidak ada data untuk diekspor'); return; }
  let csv = 'Jenis,Tanggal,Waktu,Nama/Pengganti,Digantikan\n';
  dataBulan.forEach(d=>{
    if(d.jenis === 'Absen') csv += `Absen,${d.tanggal},${d.waktu},${d.nama},\n`;
    else csv += `Gantikan,${d.tanggal},${d.waktu},${d.pengganti},${d.digantikan}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `laporan_absensi_${prefix}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  showToast('CSV diunduh');
}

// ===================== Statistik / Ranking =====================
function tampilkanRanking(){
  const stats = {};
  karyawan.forEach(k => stats[k] = { hadir:0, menggantikan:0, digantikan:0 });
  data.forEach(d=>{
    if(d.jenis === 'Absen' && stats[d.nama]) stats[d.nama].hadir++;
    if(d.jenis === 'Gantikan'){
      if(stats[d.pengganti]) stats[d.pengganti].menggantikan++;
      if(stats[d.digantikan]) stats[d.digantikan].digantikan++;
    }
  });
  const order = [...karyawan].sort((a,b) => stats[b].hadir - stats[a].hadir);
  const ovInner = document.querySelector('#overlay .overlay-inner');
  ovInner.innerHTML = `<h3>üèÜ Statistik Total Kehadiran</h3>`;
  order.forEach((k,i)=>{
    const s = stats[k];
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div><strong>${i<3 ? (i===0?'ü•á':i===1?'ü•à':'ü•â') : '#'+(i+1)} ${k}</strong><div class="muted">Hadir:${s.hadir} ‚Ä¢ Ganti:${s.menggantikan} ‚Ä¢ Diganti:${s.digantikan}</div></div>`;
    ovInner.appendChild(div);
  });
  const b = document.createElement('div'); b.className='batal-btn-overlay'; b.innerText='Tutup'; b.onclick=tutupOverlay;
  ovInner.appendChild(b);
  document.getElementById('overlay').style.display = 'block';
}

// ===================== Status Ringkas & Filter Riwayat =====================
function updateStatusRingkas(){
  const hadirHariIni = data.filter(d => d.tanggal === todayDate() && d.jenis === 'Absen').length;
  document.getElementById('status-ringkas').textContent = `${hadirHariIni} hadir hari ini`;
}

function mulaiFilterRiwayat(){
  const ovInner = document.querySelector('#overlay .overlay-inner');
  ovInner.innerHTML = `<h3>Filter Riwayat</h3><div style="margin-top:8px"></div>`;
  const body = ovInner.querySelector('div');
  const allBtn = document.createElement('div'); allBtn.className='list-item'; allBtn.innerText='Semua'; allBtn.onclick = ()=>{ filterAktif='Semua'; tutupOverlay(); tampilkan(); };
  body.appendChild(allBtn);
  karyawan.forEach(n=>{
    const el = document.createElement('div'); el.className='list-item'; el.innerHTML = `<strong>${n}</strong><div class="muted">Filter untuk ${n}</div>`;
    el.onclick = ()=>{ filterAktif = n; tutupOverlay(); tampilkan(); };
    body.appendChild(el);
  });
  const b = document.createElement('div'); b.className='batal-btn-overlay'; b.innerText='Batal'; b.onclick=tutupOverlay;
  ovInner.appendChild(b);
  document.getElementById('overlay').style.display = 'block';
}

// ===================== PENGATURAN LENGKAP (Tab) =====================

// applyTheme & inisialisasi tema (biru‚Äìabu default)
function applyTheme(theme, bg){
  const body = document.body;
  // reset any custom accent changes
  document.documentElement.style.removeProperty('--accent-start');
  document.documentElement.style.removeProperty('--accent-end');

  body.classList.remove('dark-body');
  document.querySelectorAll('.card-action, .riwayat-item, .list-item, .day-box').forEach(el=>el.classList.remove('dark-card'));

  if(theme === 'dark'){
    body.classList.add('dark-body');
    document.querySelectorAll('.card-action, .riwayat-item, .list-item, .day-box').forEach(el=>el.classList.add('dark-card'));
    document.getElementById('current-theme').textContent = 'Gelap';
    // keep accent but darker
    document.documentElement.style.setProperty('--accent-start', '#1F2937');
    document.documentElement.style.setProperty('--accent-end', '#334155');
  } else if(theme === 'blue'){
    // default blue theme
    document.documentElement.style.setProperty('--accent-start', '#2B6CB0');
    document.documentElement.style.setProperty('--accent-end', '#4C7CBD');
    document.getElementById('current-theme').textContent = 'Biru‚ÄìAbu';
  } else if(theme === 'coklat'){
    document.documentElement.style.setProperty('--accent-start', '#5A2E0A');
    document.documentElement.style.setProperty('--accent-end', '#B65C1E');
    document.getElementById('current-theme').textContent = 'Coklat';
  } else {
    document.getElementById('current-theme').textContent = 'Default';
  }

  if(bg){
    body.style.backgroundImage = `url(${bg})`;
    body.style.backgroundRepeat = 'no-repeat';
    body.style.backgroundSize = 'cover';
  } else {
    body.style.backgroundImage = 'none';
  }

  savedTheme = theme;
  savedBg = bg || null;
  localStorage.setItem(STORAGE_THEME, savedTheme);
  localStorage.setItem(STORAGE_BG, savedBg || '');
}

applyTheme(savedTheme || 'blue', savedBg || null);

// Tampilkan Pengaturan (tabbed)
function tampilkanPengaturan(){
  mode = null; pengganti = null;
  const ovInner = document.querySelector('#overlay .overlay-inner');
  ovInner.innerHTML = `
    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap">
      <button class="card-action small" id="tab-karyawan">üë• Karyawan</button>
      <button class="card-action small" id="tab-jadwal">üóìÔ∏è Jadwal Mingguan</button>
      <button class="card-action small" id="tab-tampilan">üé® Tampilan</button>
      <button class="card-action small" id="tab-batas">‚è∞ Batas Waktu Absen</button>
      <button class="card-action small" id="tab-backup">üíæ Backup & Restore</button>
      <button class="card-action small" id="tab-lainnya">‚öôÔ∏è Lainnya</button>
    </div>
    <div id="pengaturan-body"></div>
  `;
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('tab-karyawan').onclick = renderKaryawanSettings;
  document.getElementById('tab-jadwal').onclick = renderJadwalSettings;
  document.getElementById('tab-tampilan').onclick = renderTampilanSettings;
  document.getElementById('tab-batas').onclick = renderBatasWaktuSettings;
  document.getElementById('tab-backup').onclick = renderBackupSettings;
  document.getElementById('tab-lainnya').onclick = renderLainnyaSettings;
  renderKaryawanSettings();
}

// Karyawan
function renderKaryawanSettings(){
  const body = document.getElementById('pengaturan-body');
  body.innerHTML = `
    <h3>üë• Kelola Karyawan</h3>
    <div id="karyawan-list" style="margin-top:8px"></div>
    <label>Tambah Karyawan:</label>
    <div style="display:flex; gap:8px; margin-top:6px">
      <input type="text" id="input-nama-baru" placeholder="Nama baru...">
      <button class="card-action" id="btn-tambah-nama">‚ûï Tambah</button>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px">
      <button class="card-action" id="btn-simpan-karyawan">Simpan & Tutup</button>
      <button class="card-action" id="btn-reset-karyawan" style="background:#ffcccb; color:#000">Reset Karyawan Default</button>
    </div>
  `;
  refreshKaryawanListUI();

  document.getElementById('btn-tambah-nama').onclick = ()=>{
    const v = document.getElementById('input-nama-baru').value.trim();
    if(!v){ showToast('Masukkan nama'); return; }
    if(karyawan.includes(v)){ showToast('Nama sudah ada'); return; }
    karyawan.push(v);
    localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan));
    document.getElementById('input-nama-baru').value = '';
    refreshKaryawanListUI();
    showToast('Karyawan ditambahkan');
  };

  document.getElementById('btn-simpan-karyawan').onclick = ()=>{
    localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan));
    showToast('Perubahan karyawan disimpan');
    tutupOverlay();
    tampilkan();
  };

  document.getElementById('btn-reset-karyawan').onclick = ()=>{
    if(!confirm('Reset daftar karyawan ke default?')) return;
    karyawan = ["Lala","Zaki","Kemi","Haris","Izzul","Fawaz"];
    localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan));
    refreshKaryawanListUI();
    showToast('Daftar karyawan direset');
  };
}

function refreshKaryawanListUI(){
  const listWrap = document.getElementById('karyawan-list');
  listWrap.innerHTML = '';
  karyawan.forEach((n, idx)=>{
    const row = document.createElement('div');
    row.className = 'list-item';
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.justifyContent = 'space-between';
    row.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; flex:1">
        <input type="text" data-idx="${idx}" value="${n}" style="flex:1; padding:6px; border-radius:8px; border:1px solid #ddd">
      </div>
      <div style="display:flex; gap:6px; margin-left:8px">
        <button class="card-action small" data-action="save" data-idx="${idx}">Simpan</button>
        <button class="card-action small" data-action="hapus" data-idx="${idx}" style="background:#ffdddd">Hapus</button>
      </div>
    `;
    listWrap.appendChild(row);
    row.querySelector('[data-action="save"]').onclick = (e)=>{
      const i = Number(e.target.dataset.idx);
      const newName = row.querySelector(`input[data-idx="${i}"]`).value.trim();
      if(!newName){ showToast('Nama tidak boleh kosong'); return; }
      if(karyawan.includes(newName) && karyawan[i] !== newName){ showToast('Nama duplikat'); return; }
      karyawan[i] = newName;
      localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan));
      refreshKaryawanListUI();
      showToast('Nama disimpan');
    };
    row.querySelector('[data-action="hapus"]').onclick = (e)=>{
      const i = Number(e.target.dataset.idx);
      if(!confirm(`Hapus ${karyawan[i]}?`)) return;
      karyawan.splice(i,1);
      localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan));
      refreshKaryawanListUI();
      showToast('Karyawan dihapus');
    };
  });
}

// Jadwal Mingguan
function renderJadwalSettings(){
  const body = document.getElementById('pengaturan-body');
  body.innerHTML = `<h3>üóìÔ∏è Jadwal Mingguan</h3><div id="jadwal-days" style="margin-top:8px"></div>
    <div style="display:flex; gap:8px; margin-top:10px">
      <button class="card-action" id="btn-simpan-jadwal">Simpan Jadwal</button>
      <button class="card-action" id="btn-bersihkan-jadwal" style="background:#ffcccb; color:#000">Bersihkan Semua</button>
    </div>
  `;
  const wrap = document.getElementById('jadwal-days');
  wrap.innerHTML = '';
  const days = ["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu","Minggu"];
  days.forEach(day=>{
    const box = document.createElement('div');
    box.className = 'day-box';
    box.innerHTML = `<strong>${day}</strong><div style="margin-top:8px" id="ch-${day}"></div>`;
    wrap.appendChild(box);
    const chWrap = box.querySelector(`#ch-${day}`);
    karyawan.forEach(k=>{
      const id = `chk-${day}-${k}`;
      const checked = (jadwalMingguan[day] || []).includes(k);
      const el = document.createElement('label');
      el.style.display='inline-flex';
      el.style.alignItems='center';
      el.style.gap='6px';
      el.style.padding='4px 6px';
      el.style.marginRight='6px';
      el.style.borderRadius='8px';
      el.style.background='rgba(0,0,0,0.03)';
      el.innerHTML = `<input type="checkbox" id="${id}" data-day="${day}" data-name="${k}" ${checked ? 'checked' : ''}> ${k}`;
      chWrap.appendChild(el);
    });
  });

  document.getElementById('btn-simpan-jadwal').onclick = ()=>{
    const newJ = {};
    days.forEach(d=>newJ[d]=[]);
    document.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      const day = chk.dataset.day;
      const name = chk.dataset.name;
      if(day && name){
        if(!newJ[day]) newJ[day] = [];
        if(chk.checked) newJ[day].push(name);
      }
    });
    jadwalMingguan = newJ;
    localStorage.setItem(STORAGE_JADWAL, JSON.stringify(jadwalMingguan));
    showToast('Jadwal disimpan');
    tutupOverlay();
  };

  document.getElementById('btn-bersihkan-jadwal').onclick = ()=>{
    if(!confirm('Kosongkan seluruh jadwal mingguan?')) return;
    days.forEach(d=>jadwalMingguan[d]=[]);
    localStorage.setItem(STORAGE_JADWAL, JSON.stringify(jadwalMingguan));
    renderJadwalSettings();
    showToast('Jadwal dikosongkan');
  };
}

// Tampilan (tema & background)
function renderTampilanSettings(){
  const body = document.getElementById('pengaturan-body');
  body.innerHTML = `
    <h3>üé® Tampilan & Tema</h3>
    <label>Pilih Tema:</label>
    <select id="select-theme">
      <option value="blue">Biru‚ÄìAbu (Default)</option>
      <option value="dark">Gelap</option>
      <option value="coklat">Coklat</option>
    </select>

    <label>Background (URL, kosongkan untuk default):</label>
    <input type="text" id="input-bg-url" placeholder="https://...">

    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="card-action" id="btn-apply-theme">Terapkan</button>
      <button class="card-action" id="btn-reset-theme" style="background:#ffcccb; color:#000">Reset Tema</button>
    </div>
  `;
  document.getElementById('select-theme').value = savedTheme || 'blue';
  document.getElementById('input-bg-url').value = savedBg || '';

  document.getElementById('btn-apply-theme').onclick = ()=>{
    const t = document.getElementById('select-theme').value;
    const bg = document.getElementById('input-bg-url').value.trim();
    applyTheme(t, bg || null);
    showToast('Tema diterapkan');
  };
  document.getElementById('btn-reset-theme').onclick = ()=>{
    if(!confirm('Reset tema ke default?')) return;
    applyTheme('blue', null);
    localStorage.removeItem(STORAGE_BG);
    showToast('Tema direset');
  };
}

// Batas Waktu Absen
function renderBatasWaktuSettings(){
  const s = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || '{}');
  const body = document.getElementById('pengaturan-body');
  body.innerHTML = `
    <h3>‚è∞ Batas Waktu Absen</h3>
    <label><input type="checkbox" id="chk-batas" ${s.batasAbsenAktif ? 'checked' : ''}> Aktifkan batas waktu absen</label>
    <label>Jam batas (HH:MM):</label>
    <input type="time" id="input-batas-jam" value="${s.batasAbsenJam || '09:00'}">
    <label style="margin-top:8px"><input type="checkbox" id="chk-suara" ${s.notifikasiSuara ? 'checked' : ''}> Suara notifikasi saat absen berhasil</label>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="card-action" id="btn-save-batas">Simpan</button>
    </div>
  `;
  document.getElementById('btn-save-batas').onclick = ()=>{
    const aktif = document.getElementById('chk-batas').checked;
    const jam = document.getElementById('input-batas-jam').value || '09:00';
    const suara = document.getElementById('chk-suara').checked;
    settings.batasAbsenAktif = aktif;
    settings.batasAbsenJam = jam;
    settings.notifikasiSuara = suara;
    localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
    // update global settings var
    try{ settings = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || '{}'); }catch(e){}
    showToast('Pengaturan batas waktu disimpan');
    tutupOverlay();
  };
}

// Backup & Restore
function renderBackupSettings(){
  const body = document.getElementById('pengaturan-body');
  body.innerHTML = `
    <h3>üíæ Backup & Restore</h3>
    <p class="muted">Ekspor / impor semua data aplikasi (absensi, karyawan, jadwal, theme, settings).</p>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="card-action" id="btn-export-json">‚¨áÔ∏è Ekspor Semua (JSON)</button>
      <label style="display:inline-flex; align-items:center; gap:8px">
        <input type="file" id="file-import" accept="application/json" style="display:none">
        <button class="card-action" id="btn-trigger-import">‚¨ÜÔ∏è Impor JSON</button>
      </label>
    </div>
  `;
  document.getElementById('btn-export-json').onclick = backupExport;
  document.getElementById('btn-trigger-import').onclick = ()=>{
    document.getElementById('file-import').click();
  };
  document.getElementById('file-import').onchange = backupImport;
}

function backupExport(){
  const payload = {
    absensi: data,
    karyawan: karyawan,
    jadwalMingguan: jadwalMingguan,
    theme: savedTheme,
    backgroundImage: savedBg,
    settings: settings
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `backup_absensi_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  showToast('Backup JSON diunduh');
}

function backupImport(e){
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(!confirm('Impor akan menimpa data saat ini. Lanjutkan?')) { e.target.value = ''; return; }
  const fr = new FileReader();
  fr.onload = evt=>{
    try{
      const obj = JSON.parse(evt.target.result);
      if(obj.karyawan) { karyawan = obj.karyawan; localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan)); }
      if(obj.absensi) { data = obj.absensi; localStorage.setItem(STORAGE_ABSENSI, JSON.stringify(data)); }
      if(obj.jadwalMingguan) { jadwalMingguan = obj.jadwalMingguan; localStorage.setItem(STORAGE_JADWAL, JSON.stringify(jadwalMingguan)); }
      if(obj.theme) { savedTheme = obj.theme; localStorage.setItem(STORAGE_THEME, savedTheme); }
      if(obj.backgroundImage) { savedBg = obj.backgroundImage; localStorage.setItem(STORAGE_BG, savedBg || ''); }
      if(obj.settings) { settings = obj.settings; localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings)); }
      applyTheme(savedTheme || 'blue', savedBg || null);
      tampilkan();
      showToast('Impor berhasil');
      tutupOverlay();
    }catch(err){
      console.error(err);
      showToast('File JSON tidak valid');
    } finally { e.target.value = ''; }
  };
  fr.readAsText(f);
}

// Lainnya (reset & tentang)
function renderLainnyaSettings(){
  const body = document.getElementById('pengaturan-body');
  body.innerHTML = `
    <h3>‚öôÔ∏è Lainnya</h3>
    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="card-action" id="btn-reset-absensi" style="background:#ffb3b3">‚ö†Ô∏è Hapus Semua Data Absensi</button>
      <button class="card-action" id="btn-reset-semua" style="background:#ff8c8c">‚ö†Ô∏è Reset Semua (Absensi, Karyawan, Jadwal)</button>
    </div>
    <div style="margin-top:12px; padding:12px; background:var(--card); border-radius:8px">
      <strong>Versi:</strong> 1.0.0<br>
      <strong>Aplikasi:</strong> Absensi Angkringan Modern<br>
      <small class="muted">Dibuat otomatis ‚Äî gunakan fitur Backup sebelum reset.</small>
    </div>
  `;
  document.getElementById('btn-reset-absensi').onclick = ()=>{
    if(!confirm('Hapus semua data absensi? (aksi ini tidak menghapus daftar karyawan)')) return;
    data = [];
    localStorage.removeItem(STORAGE_ABSENSI);
    tampilkan();
    showToast('Semua data absensi dihapus');
    tutupOverlay();
  };
  document.getElementById('btn-reset-semua').onclick = ()=>{
    if(!confirm('Reset semua data (absensi, karyawan, jadwal)?')) return;
    data = [];
    karyawan = ["Lala","Zaki","Kemi","Haris","Izzul","Fawaz"];
    jadwalMingguan = {"Senin":[],"Selasa":[],"Rabu":[],"Kamis":[],"Jumat":[],"Sabtu":[],"Minggu":[]};
    localStorage.removeItem(STORAGE_ABSENSI);
    localStorage.setItem(STORAGE_KARYAWAN, JSON.stringify(karyawan));
    localStorage.setItem(STORAGE_JADWAL, JSON.stringify(jadwalMingguan));
    showToast('Semua data direset');
    tampilkan();
    tutupOverlay();
  };
}

// Safety: tutup overlay on Escape
document.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Escape'){
    if(document.getElementById('overlay').style.display === 'block') tutupOverlay();
  }
});

// storage event sync
window.addEventListener('storage', (e)=>{
  if(e.key === STORAGE_KARYAWAN){
    try{ karyawan = JSON.parse(e.newValue || '[]'); }catch(){}
  }
});

// On load
updateStatusRingkas();
tampilkan();

// expose some functions to window for inline onclicks
window.mulaiAbsen = mulaiAbsen;
window.mulaiAbsenTanggalLain = mulaiAbsenTanggalLain;
window.mulaiGantikan = mulaiGantikan;
window.tampilkanRanking = tampilkanRanking;
window.tampilkanLaporanBulanan = tampilkanLaporanBulanan;
window.tampilkanStatus = function(){ alert('Fungsi Status belum diisi'); };
window.tampilkanPengaturan = tampilkanPengaturan;
window.tampilkan = tampilkan;
window.hapusRiwayat = hapusRiwayat;

</script>
</body>
</html>